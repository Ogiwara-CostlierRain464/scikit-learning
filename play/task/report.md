# 大気汚染データと天候データのデータ分析
荻原湧志 71970013

# 目的
大気汚染データ及び天候データを用いて、PM2.5の測定量と天候との関係を見出す。

# 方法
PM2.5の測定量と、天候との関係を見出すために、そらまめ君[1]及び気象庁の気象データ[2]のデータを分析した。
PM2.5の測定量が多くなると言われている5月のデータをもとに、教師あり機械学習を用いた分析を行なった。
インターネットの接続状況が不安定だったため、Google Colaboratoryではなく手元のローカルマシンで分析を行なった。


# 手順
## そらまめ君[1]のデータをダウンロード

まずは以下のコードでデータをダウンロードし、`soramame.csv`として保存した。
```shell script
wget http://soramame.taiki.go.jp/DownLoad/201905/201905_00.zip

# ダウンロードしたデータを展開
mkdir data
for f in 201905_00.zip; do
  unzip $f -d data
done

mkdir csv
for f in data/*.zip; do
  unzip $f -d csv
done

# 2019/05での神奈川県(県番号14)の辻堂(観測局番号14204010)
# のデータをsoramame.csvとして保存
cp csv/14/201905_14_14204010.csv soramame.csv
```

## 気象庁の気象データ[2]をダウンロード
気象データは[2]をもとに、2019/05/01から2019/05/31の期間での
辻堂の1時間ごとの気温、日照時間、降水量、風向き、風速、蒸気圧、雲量のデータをダウンロードした。
このデータはこのままでは扱えないので、1,2,3,5行目を消し、4行目の二つ目の「風速(m/s)」を「風向」に変えた。

## データの整形

データの整形は以下のコードを用いて行なった。
まず、大気汚染データ、天候データそれぞれについて時刻をインデックスとして設定し、二つのデータフレームを結合した。

その後、蒸気圧・雲量のカラムについては全てのデータが欠損していたのでカラムを削除し、
風向については有益な情報が得られないと判断しこのカラムもまた削除した。

日照時間、PM2.5のデータでデータが欠損している部分はそれぞれ適切な方法でデータを補った。

```python
import pandas as pd

# soramame.csvの整形
df2 = pd.read_csv("soramame.csv", encoding="SHIFT-JIS")
df2 = pd.concat([df2, df2["日付"].str.split("/", expand=True)], axis=1)
df2.rename(columns={0: "YYYY", 1: "MM", 2: "DD"}, inplace=True)
df2["日時"] = df2["YYYY"] + "-" + df2["MM"] + "-" + df2["DD"] + " " + (df2["時"] - 1).astype(str) + ":00:00"
df2["日時"] = pd.to_datetime(df2["日時"])
df2 = df2.set_index("日時")

# weather.csvの整形
df = pd.read_csv("weather.csv", encoding="SHIFT-JIS")
df["年月日時"] = pd.to_datetime(df["年月日時"])
df = df.set_index("年月日時")

# 大気汚染データと天候データをまとめる
data = df.join(df2)

# 風向、蒸気圧、雲量は使えなさそうだ
data = data.drop(["風向", "蒸気圧(hPa)", "雲量(10分比)"], axis=1)

# 日照時間は日がそもそも出てないとnanになっているので0に
data["日照時間(時間)"].fillna(0, inplace=True)

# PM2.5はnanは平均値で置き換え
data["PM2.5(ug/m3)"].fillna(data["PM2.5(ug/m3)"].mean(), inplace=True)
```

## データの分析
データの分析を実際に行うコードは文献[3]にて公開した。
各カラムのデータをグラフとして可視化したところ、気温と日照時間については日毎に上下するデータとなっており、明らかに
PM2.5のデータ分布とかけ離れていたので、これらを除いた風量・雨量をもとにPM2.5の測定量の予測モデルを構築することを試みた。

Random Forest, RVR, Lassoでそれぞれモデル構築を試み、性能評価としてMSEを採用した。
結果、どのモデルにおいてもMSEが40を上回り、明らかに適切なモデルの構築に失敗していた。

よくよくデータの相関係数を確認したところ、そもそも風量・雨量はPM2.5とはほとんど相関がなく、
PM2.5と相関があるデータは唯一、相関係数が0.8であるSPMの値であることがわかった。

そこでSPMを入力としてRandom Forestを用いてPM2.5の予測モデルを構築したところ、MSEが8となり、一気に評価が改善した。

# わかったこと
各データの相関係数を見ても明らかなように、天候とPM2.5の値の相関性は低く、天候データをもとにPM2.5の測定量を予測することは難しいと考えられる。

# 感想
平均・分散・相関係数などまずは基本的な統計量をしっかり確認した後、予測モデルを構築することが重要であると認識した。

# 文献
1. そらまめ君 http://soramame.taiki.go.jp/ 2020/5/25閲覧
2. 気象庁 気象データ http://www.data.jma.go.jp/gmd/risk/obsdl/index.php 2020/5/25閲覧
3. データ分析に用いたコード https://github.com/Ogiwara-CostlierRain464/scikit-learning/blob/master/play/task/task.py 